###  happens-before

- happens-before是JMM最核心的概念。对应Java程序员来说，理解happens-before是理解JMM的关键。

##### JMM的设计

- 首先，让我们来看JMM的设计意图。从JMM设计者的角度，在设计JMM时，需要考虑两个关键因素。
  1. 程序员对内存模型的使用。
     - 程序员希望内存模型易于理解、易于编程。
     - 程序员希望基于一个强内存模型来编写代码。
  2. 编译器和处理器对内存模型的实现。
     - 编译器和处理器希望内存模型对它们的束缚越少越好，这样它们就可以做尽可能多的优化来提高性能。
     - 编译器和处理器希望实现一个弱内存模型。
- 由于这两个因素互相矛盾，所以JSR-133专家组在设计JMM时的核心目标就是找到一个好的平衡点：
  - 一方面，要为程序员提供足够强的内存可见性保证；
  - 另一方面，对编译器和处理器的限制要尽可能地放松。
- 下面让我们来看JSR-133是如何实现这一目标的。

```Java
double pi = 3.14;	//A
double r = 1.0;		//B
double area = pi * r * r;	//c
```

- 上面计算圆的面积的示例代码存在3个happens-before关系，如下。
  1. A happens-before B。
  2. B happens-before C。
  3. A happens-before C。
- 在3个happens-before关系中，2和3是必需的，但1是不必要的。
- 因此，JMM把happens-before要求禁止的重排序分为了下面两类。
  1. 会改变程序执行结果的重排序。
  2. 不会改变程序执行结果的重排序。
- JMM对这两种不同性质的重排序，采取了不同的策略，如下。
  1. 对于会改变程序执行结果的重排序，JMM要求编译器和处理器必须禁止这种重排序。
  2. 对于不会改变程序执行结果的重排序，JMM对编译器和处理器不做要求（JMM允许这种重排序）。
- 下图是JMM的设计示意图。![JMM的设计示意图]()
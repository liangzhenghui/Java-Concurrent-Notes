### volatile的内存语义

- 当声明共享变量为volatile后，对这个变量的读/写将会很特别。

##### volatile的特性

- 理解volatile特性的一个好方法是把对volatile变量的单个读/写，看成是使用同一个锁对这些单个读/写操作做了同步。

```Java
public class VolatileFeaturesExample {

    volatile long v1 = 0L;  //使用volatile声明64位的long型变量

    public void set(long l) {   //单个volatile变量的写
        v1 = l;
    }

    public void getAndIncrement() { //复合（多个）volatile变量的读/写
        v1++;
    }

    public long get() { //单个volatile变量的读
        return v1;
    }
}
```

- 等价于：

```Java
public class VolatileFeaturesExample {

    long v1 = 0L;  //使64位的long型变量
  
    public synchronized void set(long l) {   //对单个的普通变量的写用同一个锁同步
        v1 = l;
    }
  
    public void getAndIncrement() { //普通方法调用
        long temp = get();          //调用已同步的读方法
        temp += 1L;                 //普通写操作
        set(temp);                  //调用已同步的写方法
    }

    public synchronized long get() { //对单个的普通变量的读用同一个锁同步
        return v1;
    }
}
```

- 如上面示例程序所示，一个volatile变量的单个读/写操作，与一个普通变量的读/写操作都是使用同一个锁来同步，它们之间的执行效果相同。
- 锁的happens-before规则保证释放锁和获取锁的两个线程之间的内存可见性，这意味着对一个volatile变量的读，总是能看到（任意线程）对这个volatile变量最后的写入。
- 锁的语义决定了临界区代码的执行具有原子性。这意味着，即使是64位的long型和double型变量，只要它是volatile变量，对该变量的读/写就具有原子性。
- 如果是多个volatile操作或类似于volatile++这种复合操作，这些操作整体上不具有原子性。
- volatile变量自身具有下列特性:
  1. 可见性。
     - 对一个volatile变量的读，总是能看到（任意线程）对这个volatile变量最后的写入。
  2. 原子性：
     - 对任意单个volatile变量的读/写具有原子性，但类似于volatile++这种复合操作不具有原子性。

##### volatile写-读建立的happens-before关系

- 从JSR-133开始（即从JDK5开始），volatile变量的写-读可以实现线程之间的通信。
- 从内存语义的角度来说，volatile的写-读与锁的释放-获取有相同的内存效果：
  - volatile写和锁的释放有相同的内存语义；
  - volatile读与锁的获取有相同的内存语义。
- 请看下面使用volatile变量的示例代码:

```Java
class VolatileExample {
  
    int a = 0;
  	
  	volatile boolean flag = false;
  
  	public void writer() {
    	a = 1;	//1
      	flag = true;	//2
    }
  
  	public void reader() {
        if (flag) {	//3
            int i = a;	//4
          	//……
        }
    }
}
```

- 假设线程A执行writer()方法之后，线程B执行reader()方法。
- （在4能执行的情况下）根据happens-before规则，这个过程建立的happens-before关系可以分为3类：
  1. 根据程序次序规则，1 happens-before 2;3 happens-before 4。
  2. 根据volatile规则，2 happens-before 3。
  3. 根据happens-before的传递性规则，1 happens-before 4。
- 上述happens-before关系的图形化表现形式如下。![happens-before关系]()